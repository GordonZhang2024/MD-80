<?xml version="1.0"?>

<!-- McDonnell Douglas MD-80 Cockpit -->
<!-- Copyright (c) 2022 Josh Davidson (Octal450) -->

<system name="MD-80: Cockpit"> <!-- Everything here is after all systems -->
	
	<channel name="Animations">
		
		<!-- General -->
		<lag_filter name="/controls/cockpit/active-ap">
			<input>/it-autoflight/input/active-ap</input>
			<c1>20</c1>
		</lag_filter>
		
		<fcs_function name="/controls/cockpit/ap-cmd">
			<function>
				<max>
					<property>/it-autoflight/output/ap1</property>
					<property>/it-autoflight/output/ap2</property>
				</max>
			</function>
		</fcs_function>
		
		<lag_filter name="/controls/cockpit/ap">
			<input>/controls/cockpit/ap-cmd</input>
			<c1>20</c1>
		</lag_filter>
		
		<lag_filter name="/controls/cockpit/art">
			<input>/controls/dfgs/switches/art</input>
			<c1>20</c1>
		</lag_filter>
		
		<lag_filter name="/controls/cockpit/athr">
			<input>/it-autoflight/input/athr</input>
			<c1>20</c1>
		</lag_filter>
		
		<lag_filter name="/controls/cockpit/beacon">
			<input>/controls/lighting/beacon</input>
			<c1>20</c1>
		</lag_filter>
		
		<lag_filter name="/controls/cockpit/brake-pedal-left">
			<input>/controls/gear/brake-left</input>
			<c1>5</c1>
		</lag_filter>
		
		<lag_filter name="/controls/cockpit/brake-pedal-right">
			<input>/controls/gear/brake-right</input>
			<c1>5</c1>
		</lag_filter>
		
		<lag_filter name="/controls/cockpit/fd1">
			<input>/it-autoflight/input/fd1</input>
			<c1>20</c1>
		</lag_filter>
		
		<lag_filter name="/controls/cockpit/fd2">
			<input>/it-autoflight/input/fd2</input>
			<c1>20</c1>
		</lag_filter>
		
		<linear_actuator name="/controls/cockpit/flex-d1-linear">
			<input>/controls/tri/flex-d1</input>
			<module>10</module>
		</linear_actuator>
		
		<lag_filter name="/controls/cockpit/flex-d1-lag">
			<input>/controls/cockpit/flex-d1-linear</input>
			<c1>20</c1>
		</lag_filter>
		
		<fcs_function name="/controls/cockpit/flex-d1"> <!-- Undo the linear actuator for textranslate -->
			<function> <!-- Modulo 10 without rounding -->
				<difference>
					<property>/controls/cockpit/flex-d1-lag</property>
					<product>
						<floor>
							<quotient>
								<property>/controls/cockpit/flex-d1-lag</property>
								<value>10</value>
							</quotient>
						</floor>
						<value>10</value>
					</product>
				</difference>
			</function>
		</fcs_function>
		
		<linear_actuator name="/controls/cockpit/flex-d10-linear">
			<input>/controls/tri/flex-d10</input>
			<module>6</module>
		</linear_actuator>
		
		<lag_filter name="/controls/cockpit/flex-d10-lag">
			<input>/controls/cockpit/flex-d10-linear</input>
			<c1>20</c1>
		</lag_filter>
		
		<fcs_function name="/controls/cockpit/flex-d10"> <!-- Undo the linear actuator for textranslate -->
			<function> <!-- Modulo 6 without rounding -->
				<difference>
					<property>/controls/cockpit/flex-d10-lag</property>
					<product>
						<floor>
							<quotient>
								<property>/controls/cockpit/flex-d10-lag</property>
								<value>6</value>
							</quotient>
						</floor>
						<value>6</value>
					</product>
				</difference>
			</function>
		</fcs_function>
		
		<lag_filter name="/controls/cockpit/fu-reset">
			<input>/controls/engines/fu-reset</input>
			<c1>20</c1>
		</lag_filter>
		
		<actuator name="/controls/cockpit/gear-lever">
			<input>/controls/gear/lever-cockpit</input>
			<rate_limit>4.5</rate_limit>
			<lag>20</lag>
		</actuator>
		
		<lag_filter name="/controls/cockpit/ground-flood-light-l">
			<input>/controls/lighting/ground-flood-light-l</input>
			<c1>20</c1>
		</lag_filter>
		
		<lag_filter name="/controls/cockpit/ground-flood-light-r">
			<input>/controls/lighting/ground-flood-light-r</input>
			<c1>20</c1>
		</lag_filter>
		
		<lag_filter name="/controls/cockpit/hyd-aux-pump">
			<input>/controls/hydraulics/switches/aux-pump</input>
			<c1>20</c1>
		</lag_filter>
		
		<lag_filter name="/controls/cockpit/hyd-l-pump">
			<input>/controls/hydraulics/switches/l-pump</input>
			<c1>20</c1>
		</lag_filter>
		
		<lag_filter name="/controls/cockpit/hyd-r-pump">
			<input>/controls/hydraulics/switches/r-pump</input>
			<c1>20</c1>
		</lag_filter>
		
		<lag_filter name="/controls/cockpit/hyd-trans">
			<input>/controls/hydraulics/switches/trans</input>
			<c1>20</c1>
		</lag_filter>
		
		<lag_filter name="/controls/cockpit/landing-light-l">
			<input>/controls/lighting/landing-light-l</input>
			<c1>20</c1>
		</lag_filter>
		
		<lag_filter name="/controls/cockpit/landing-light-n">
			<input>/controls/lighting/landing-light-n</input>
			<c1>20</c1>
		</lag_filter>
		
		<lag_filter name="/controls/cockpit/landing-light-r">
			<input>/controls/lighting/landing-light-r</input>
			<c1>20</c1>
		</lag_filter>
		
		<lag_filter name="/controls/cockpit/nd1-dimmer">
			<input>/instrumentation/du/nd1-dimmer</input>
			<c1>20</c1>
		</lag_filter>
		
		<lag_filter name="/controls/cockpit/nd2-dimmer">
			<input>/instrumentation/du/nd2-dimmer</input>
			<c1>20</c1>
		</lag_filter>
		
		<lag_filter name="/controls/cockpit/pfd1-dimmer">
			<input>/instrumentation/du/pfd1-dimmer</input>
			<c1>20</c1>
		</lag_filter>
		
		<lag_filter name="/controls/cockpit/pfd2-dimmer">
			<input>/instrumentation/du/pfd2-dimmer</input>
			<c1>20</c1>
		</lag_filter>
		
		<lag_filter name="/controls/cockpit/landing-light-r">
			<input>/controls/lighting/landing-light-r</input>
			<c1>20</c1>
		</lag_filter>
		
		<lag_filter name="/controls/cockpit/position-strobe-light">
			<input>/controls/lighting/position-strobe-light</input>
			<c1>20</c1>
		</lag_filter>
		
		<lag_filter name="/controls/cockpit/vor-adf-1[0]">
			<input>/instrumentation/rmi[0]/vor-adf-1</input>
			<c1>20</c1>
		</lag_filter>
		
		<lag_filter name="/controls/cockpit/vor-adf-1[1]">
			<input>/instrumentation/rmi[1]/vor-adf-1</input>
			<c1>20</c1>
		</lag_filter>
		
		<lag_filter name="/controls/cockpit/vor-adf-2[0]">
			<input>/instrumentation/rmi[0]/vor-adf-2</input>
			<c1>20</c1>
		</lag_filter>
		
		<lag_filter name="/controls/cockpit/vor-adf-2[1]">
			<input>/instrumentation/rmi[1]/vor-adf-2</input>
			<c1>20</c1>
		</lag_filter>
		
		<lag_filter name="/controls/cockpit/wing-lights">
			<input>/controls/lighting/wing-lights</input>
			<c1>20</c1>
		</lag_filter>
		
		<!-- Pedestal -->
		<lag_filter name="/controls/cockpit/abs-armed">
			<input>/controls/gear/abs/armed</input>
			<c1>20</c1>
		</lag_filter>
		
		<lag_filter name="/controls/cockpit/abs-knob">
			<input>/controls/gear/abs/knob</input>
			<c1>20</c1>
		</lag_filter>
		
		<actuator name="/controls/cockpit/brake-lever">
			<input>/controls/gear/brake-parking</input>
			<rate_limit>2.5</rate_limit>
			<lag>20</lag>
		</actuator>
		
		<lag_filter name="/controls/cockpit/elevator-trim-lever">
			<input>/controls/flight/elevator-trim-lever</input>
			<c1>20</c1>
		</lag_filter>
		
		<lag_filter name="/controls/cockpit/engine-cutoff[0]">
			<input>/controls/engines/engine[0]/cutoff-switch</input>
			<c1>20</c1>
		</lag_filter>
		
		<lag_filter name="/controls/cockpit/engine-cutoff[1]">
			<input>/controls/engines/engine[1]/cutoff-switch</input>
			<c1>20</c1>
		</lag_filter>
		
		<lag_filter name="/controls/cockpit/flaps-lever-rotate">
			<input>/controls/flight/flaps-input</input>
			<c1>20</c1>
		</lag_filter>
		
		<lag_filter name="/controls/cockpit/flaps-lever-translate">
			<input>/controls/cockpit/flaps-lever-translate-cmd</input>
			<c1>30</c1>
		</lag_filter>
		
		<lag_filter name="/controls/cockpit/reverse-lever[0]">
			<input>/controls/engines/engine[0]/reverse-lever</input>
			<c1>20</c1>
		</lag_filter>
		
		<lag_filter name="/controls/cockpit/reverse-lever[1]">
			<input>/controls/engines/engine[1]/reverse-lever</input>
			<c1>20</c1>
		</lag_filter>
		
		<lag_filter name="/controls/cockpit/throttle-lever[0]">
			<input>engine/control-1/throttle-pos</input>
			<c1>20</c1>
			<output>engine/throttle-lever-feedback[0]</output>
		</lag_filter>
		
		<lag_filter name="/controls/cockpit/throttle-lever[1]">
			<input>engine/control-2/throttle-pos</input>
			<c1>20</c1>
			<output>engine/throttle-lever-feedback[1]</output>
		</lag_filter>
		
		<lag_filter name="/controls/cockpit/spoilers-lever-rotate">
			<input>spoilers/lever-cmd</input>
			<c1>20</c1>
		</lag_filter>
		
		<lag_filter name="/controls/cockpit/spoilers-lever-translate">
			<input>/controls/flight/speedbrake-arm</input>
			<c1>20</c1>
		</lag_filter>
		
		<lag_filter name="/controls/cockpit/x-bleed-l-lever">
			<input>/controls/pneumatics/switches/x-bleed-l</input>
			<c1>20</c1>
		</lag_filter>
		
		<lag_filter name="/controls/cockpit/x-bleed-r-lever">
			<input>/controls/pneumatics/switches/x-bleed-r</input>
			<c1>20</c1>
		</lag_filter>
		
		<lag_filter name="/controls/cockpit/x-feed-lever">
			<input>/controls/fuel/switches/x-feed</input>
			<c1>20</c1>
		</lag_filter>
	
	</channel>
	
	<channel name="Animations Execrate 4" execrate="4">
			
		<switch name="/gear/abs/lights/disarm">
			<default value="0"/>
			<test logic="AND" value="1">
				/controls/gear/lever-cockpit ge 2
				/gear/abs/knob-input ne 0
				/gear/abs/armed-input eq 0
			</test>
		</switch>
	
	</channel>
	
	<channel name="CAWS and Warnings Logic" execrate="8">
		
		<!-- Altitude Alert -->
		<switch name="/systems/caws/logic/altitude-alert-captured">
			<default value="/systems/caws/logic/altitude-alert-captured"/>
			<test value="0">
				/it-autoflight/internal/alt-diff-abs ge 800
			</test>
			<test value="1">
				/it-autoflight/internal/alt-diff-abs le 250
			</test>
		</switch>
		
		<switch name="/systems/caws/logic/altitude-alert">
			<default value="/systems/caws/logic/altitude-alert"/>
			<test logic="OR" value="0"> <!-- Reset -->
				/it-autoflight/internal/alt-diff-abs le 250
				fcs/flap-pos-deg ge 26
				/it-autoflight/output/vert eq 2
				/it-autoflight/output/vert eq 6
				position/wow eq 1
				<test logic="AND"> <!-- Approaching only -->
					/systems/caws/logic/altitude-alert eq 1
					/it-autoflight/internal/alt-diff-abs ge 800
				</test>
			</test>
			<test logic="AND" value="1"> <!-- Approaching -->
				/systems/caws/logic/altitude-alert-captured eq 0
				/it-autoflight/internal/alt-diff-abs gt 250
				/it-autoflight/internal/alt-diff-abs le 750
			</test>
			<test logic="AND" value="2"> <!-- Deviating -->
				/systems/caws/logic/altitude-alert-captured eq 1
				/it-autoflight/internal/alt-diff-abs gt 250
			</test>
		</switch>
		
		<switch name="/systems/caws/logic/altitude-alert-aural-1"> <!-- Prevent aural from playing if newly set altitude is inside the alert zone -->
			<default value="/systems/caws/logic/altitude-alert-aural-1"/>
			<test logic="AND" value="0">
				/systems/caws/logic/altitude-alert eq 0
				/it-autoflight/internal/alt-diff-abs le 700
			</test>
			<test value="1">
				/it-autoflight/internal/alt-diff-abs ge 800
			</test>
		</switch>
		
		<!-- Landing Gear -->
		<switch name="/systems/caws/logic/landing-gear-idle">
			<default value="0"/>
			<test logic="AND" value="1">
				/instrumentation/airspeed-indicator/indicated-speed-kt lt 210
				/position/gear-agl-ft le 1500
				<test logic="OR">
					engine/control-1/throttle-pos lt 0.01
					engine/control-2/throttle-pos lt 0.01
				</test>
			</test>
		</switch>
		
		<switch name="/systems/caws/logic/landing-gear-inhibit">
			<default value="0"/>
			<test value="/controls/warnings/gear-warning-inhibit">
				/systems/caws/logic/landing-gear-idle eq 1
			</test>
			<output>/controls/warnings/gear-warning-inhibit</output> <!-- So it resets properly -->
		</switch>
		
		<switch name="/systems/caws/logic/landing-gear">
			<default value="0"/>
			<test logic="AND" value="0">
				gear/unit[0]/status eq 2
				gear/unit[1]/status eq 2
				gear/unit[2]/status eq 2
			</test>
			<test logic="OR" value="1">
				<test logic="AND">
					/systems/caws/logic/landing-gear-idle eq 1
					/systems/caws/logic/landing-gear-inhibit eq 0
				</test>
				fcs/flap-pos-deg ge 26
			</test>
		</switch>
		
		<!-- Wheel Not Turning -->
		<fcs_function name="/gear/wheel-not-turning/n-l-avg">
			<function>
				<avg>
					<property>gear/unit[0]/wheel-speed-fps</property>
					<property>gear/unit[1]/wheel-speed-fps</property>
				</avg>
			</function>
		</fcs_function>
		
		<fcs_function name="/gear/wheel-not-turning/n-r-avg">
			<function>
				<avg>
					<property>gear/unit[0]/wheel-speed-fps</property>
					<property>gear/unit[2]/wheel-speed-fps</property>
				</avg>
			</function>
		</fcs_function>
		
		<fcs_function name="/gear/wheel-not-turning/l-r-avg">
			<function>
				<avg>
					<property>gear/unit[1]/wheel-speed-fps</property>
					<property>gear/unit[2]/wheel-speed-fps</property>
				</avg>
			</function>
		</fcs_function>
		
		<fcs_function name="/gear/wheel-not-turning/l-r-q-n">
			<function>
				<quotient>
					<property>/gear/wheel-not-turning/l-r-avg</property>
					<property>gear/unit[0]/wheel-speed-fps</property>
				</quotient>
			</function>
		</fcs_function>
		
		<fcs_function name="/gear/wheel-not-turning/n-r-q-l">
			<function>
				<quotient>
					<property>/gear/wheel-not-turning/n-r-avg</property>
					<property>gear/unit[1]/wheel-speed-fps</property>
				</quotient>
			</function>
		</fcs_function>
		
		<fcs_function name="/gear/wheel-not-turning/n-l-q-r">
			<function>
				<quotient>
					<property>/gear/wheel-not-turning/n-l-avg</property>
					<property>gear/unit[2]/wheel-speed-fps</property>
				</quotient>
			</function>
		</fcs_function>
		
		<switch name="/gear/wheel-not-turning/active"> <!-- If any is greater than 20% slower (1.2 quotient) while WOW -->
			<default value="0"/>
			<test logic="OR" value="0">
				gear/unit[0]/WOW eq 0
				gear/unit[1]/WOW eq 0
				gear/unit[2]/WOW eq 0
				/instrumentation/airspeed-indicator/indicated-speed-kt lt 30
			</test>
			<test logic="OR" value="1">
				/gear/wheel-not-turning/l-r-q-n ge 1.2
				/gear/wheel-not-turning/n-r-q-l ge 1.2
				/gear/wheel-not-turning/n-l-q-r ge 1.2
			</test>
		</switch>
	
	</channel>
	
	<channel name="CAWS Sound Controller" execrate="16">
		
		<!-- Autopilot Horn -->
		<switch name="/systems/caws/apoff/trigger">
			<default value="/systems/caws/apoff/trigger"/>
			<test logic="OR" value="0">
				/systems/electrical/outputs/mk-viii lt 24
				/systems/caws/apoff/out eq 1
			</test>
			<test logic="AND" value="1">
				/systems/caws/apoff/out eq 0
				/it-autoflight/sound/apoff eq 1
			</test>
		</switch>
		
		<actuator name="/systems/caws/apoff/actuator">
			<input>/systems/caws/apoff/trigger</input>
			<rate_limit sense="incr">0.35</rate_limit>
			<rate_limit sense="decr">100</rate_limit>
			<output>/systems/caws/apoff/out</output>
		</actuator>
		
		<!-- Landing Gear Horn -->
		<switch name="/systems/caws/landing-gear/trigger">
			<default value="/systems/caws/landing-gear/trigger"/>
			<test logic="OR" value="0">
				/systems/electrical/outputs/mk-viii lt 24
				/systems/caws/landing-gear/out eq 1
			</test>
			<test logic="AND" value="1">
				/systems/caws/landing-gear/out eq 0
				/systems/caws/logic/landing-gear eq 1
			</test>
		</switch>
		
		<actuator name="/systems/caws/landing-gear/actuator">
			<input>/systems/caws/landing-gear/trigger</input>
			<rate_limit sense="incr">0.35</rate_limit>
			<rate_limit sense="decr">100</rate_limit>
			<output>/systems/caws/landing-gear/out</output>
		</actuator>
	
	</channel>
	
	<channel name="Exterior Lights" execrate="8">
		
		<switch name="exterior-lights/nose-landing-light-cmd">
			<default value="0"/>
			<test logic="AND" value="0.6">
				/controls/lighting/landing-light-n eq 0.5
				/controls/gear/lever eq 1
				/gear/gear[0]/position-norm ge 0.99
			</test>
			<test logic="AND" value="1">
				/controls/lighting/landing-light-n eq 1.0
				/controls/gear/lever eq 1
				/gear/gear[0]/position-norm ge 0.99
			</test>
		</switch>
		
		<actuator name="exterior-lights/nose-landing-light-actuator">
			<input>exterior-lights/nose-landing-light-cmd</input>
			<rate_limit>7.5</rate_limit>
			<output>exterior-lights/nose-landing-light</output>
		</actuator>
		
		<switch name="exterior-lights/left-landing-light-ext-cmd">
			<default value="0"/>
			<test logic="AND" value="1">
				/controls/lighting/landing-light-l ge 0.5
			</test>
		</switch>
		
		<actuator name="exterior-lights/left-landing-light-ext-actuator">
			<input>exterior-lights/left-landing-light-ext-cmd</input>
			<rate_limit>0.14285714285</rate_limit> <!-- 7 seconds -->
			<output>exterior-lights/left-landing-light-ext</output>
		</actuator>
		
		<switch name="exterior-lights/left-landing-light-cmd">
			<default value="0"/>
			<test logic="AND" value="1">
				/controls/lighting/landing-light-l eq 1.0
				exterior-lights/left-landing-light-ext eq 1.0
			</test>
		</switch>
		
		<actuator name="exterior-lights/left-landing-light-actuator">
			<input>exterior-lights/left-landing-light-cmd</input>
			<rate_limit>5.0</rate_limit>
			<output>exterior-lights/left-landing-light</output>
		</actuator>
		
		<switch name="exterior-lights/right-landing-light-ext-cmd">
			<default value="0"/>
			<test logic="AND" value="1">
				/controls/lighting/landing-light-r ge 0.5
			</test>
		</switch>
		
		<actuator name="exterior-lights/right-landing-light-ext-actuator">
			<input>exterior-lights/right-landing-light-ext-cmd</input>
			<rate_limit>0.14285714285</rate_limit> <!-- 7 seconds -->
			<output>exterior-lights/right-landing-light-ext</output>
		</actuator>
		
		<switch name="exterior-lights/right-landing-light-cmd">
			<default value="0"/>
			<test logic="AND" value="1">
				/controls/lighting/landing-light-r eq 1.0
				exterior-lights/right-landing-light-ext eq 1.0
			</test>
		</switch>
		
		<actuator name="exterior-lights/right-landing-light-actuator">
			<input>exterior-lights/right-landing-light-cmd</input>
			<rate_limit>5.0</rate_limit>
			<output>exterior-lights/right-landing-light</output>
		</actuator>
		
		<switch name="exterior-lights/ground-flood-light-l">
			<default value="0"/>
			<test logic="AND" value="1">
				/controls/lighting/ground-flood-light-l eq 1
			</test>
		</switch>
		
		<switch name="exterior-lights/ground-flood-light-r">
			<default value="0"/>
			<test logic="AND" value="1">
				/controls/lighting/ground-flood-light-r eq 1
			</test>
		</switch>
		
		<switch name="exterior-lights/position-light">
			<default value="0"/>
			<test logic="AND" value="1">
				/controls/lighting/position-strobe-light ge 0.5
			</test>
		</switch>
		
		<switch name="exterior-lights/strobe-light">
			<default value="0"/>
			<test logic="AND" value="1">
				/controls/lighting/position-strobe-light eq 1.0
				/gear/gear[0]/wow ne 1
			</test>
		</switch>
		
		<switch name="exterior-lights/left-wing-light">
			<default value="0"/>
			<test logic="AND" value="1">
				/controls/lighting/wing-lights eq 0.5
			</test>
		</switch>
		
		<switch name="exterior-lights/right-wing-light">
			<default value="0"/>
			<test logic="AND" value="1">
				/controls/lighting/wing-lights ge 0.5
			</test>
		</switch>
	
	</channel>

</system>
